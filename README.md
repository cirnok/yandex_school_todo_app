<h6 align="center">
    <picture>
      <img alt="Done" src="assets/app_icon.png">
    </picture>
    <br>
</h6>

<h3 align="center">
Done
<h6 align="center">
  <a href="https://github.com/cirnok/todo_app/releases"><img alt="Releases" src="https://img.shields.io/badge/Releases-purple.svg"></a>
  <a href="CHANGELOG.md"><img alt="Changelog" src="https://img.shields.io/badge/Changelog-blue.svg"></a>
  <a href="https://appdistribution.firebase.dev/i/a0e67ff9f4f8cddc"><img alt="Join to Firebase App Distribution" src="https://img.shields.io/badge/Join to Firebase App Distribution-yellow.svg"></a>
  <a href="https://github.com/cirnok/todo_app/actions/workflows/android.yml"><img alt="Android" src="https://github.com/cirnok/todo_app/actions/workflows/android.yml/badge.svg"></a>
</h6>
<br>
</h3>

<p align="center">
  <img height="300" src="https://user-images.githubusercontent.com/25152332/182955150-c16f04af-6267-4119-93fb-24c8841ad143.png">
  <img height="300" src="https://user-images.githubusercontent.com/25152332/182955177-3442352c-17ac-42be-a85d-effd6838262f.png">
  <img height="300" src="https://user-images.githubusercontent.com/25152332/182955192-0211347a-026c-49eb-8775-e3f8563e59a4.png">
  <img height="300" src="https://user-images.githubusercontent.com/25152332/182955209-0dc669be-bb16-45bc-bec8-8ec93764c3f0.png">
</p>

## Описание

To-do Flutter приложение, в рамках проектной деятельности во время участия в Школе мобильной разработки Яндекса.

## Зависимости

**State management:** [`bloc`](https://pub.dev/packages/bloc)

**Dependency injection:** [`dino`](https://github.com/Exeteres/dino)

**Database:** [`hive`](https://pub.dev/packages/hive)

**Network:** [`dio`](https://pub.dev/packages/dio), [`retrofit`](https://pub.dev/packages/retrofit)

## Для разработки

Для запуска интеграционных тестов необходимо ввести команду:
`flutter pub run melos run integration_test`

Для работы с архитектурой (генерации и обновления структур) используется CLI, пока что не опубликованный в открытый доступ. В любом случае, это не мешает компиляции и просмотру кода.

## Функционал

### Добавление, удаление и редактирование задач.

Пользователь взаимодействует с локальной БД приложения, после чего выполняется асинхронная операция синхронизации с API.
Это позволяет работать с приложением максимально быстро и плавно, без необходимости ожидания подгрузки информации, либо завершения действий (создания, изменения, удаления задачи).

Если синхронизация не удалась (нет интернета, ошибка сервера и тд), то операция повторяется каждые 5 секунд, пока не окажется успешной.

В состоянии простоя, приложение синхронизирует локальную БД с данными из API каждую минуту. Также синхронизация проводится при открытии приложения, изменении состояния подключения к сети и возврате в приложение из background.

### Merging изменений локальной базы данных с данными из API.

В локальной БД хранятся не только задачи, но и состояния несинхронизированных с API изменений. При синхронизации происходит слияние данных из API с несинхронизированными изменениями из локальной БД.

Решение конфликтов при слиянии происходит по стратегии, направленной на минимализацию возможного ущерба. Это позволяет отменить удаление задач, если экземляр задачи в синхронизированной копии на сервере окажется более актуальным, чем в локальной копии (либо наоборот, на устройстве актуальнее чем на сервере), в которой была запрошена операция удаления.

Например, если пользователь удалил задачу на `устройстве 1` без доступа к сети, а на `устройстве 2`, которое может синхронизироваться с API, изменил данную задачу, то при следующей успешной синхронизации на `устройстве 1` удаление будет отменено, что позволит не потерять актуальные изменения.

Также, если на устройстве с доступом к сети удалить задачу, а потом внести изменения в экземпляре данной задачи на другом устройстве, и провести синхронизацию с API, то задача будет восстановлена на сервере.

### Deeplinks

Адреса:

- Список задач: todoapp://todoapp/
- Открыть задачу по id: todoapp://todoapp/task/:taskId
- Открыть окно создания задачи: todoapp://todoapp/task/create

### Архитектура

Структура проекта представляет собой монорепозиторий (workflow), состоящий из нескольких модулей (app, core, task).

Каждый модуль в свою очередь состоит из трёх слоёв: domain, infrastructure и presentation. Каждый слой находится в отдельном пакете и имеет строго определенные зависимости от других слоёв.

Всего выделяется три слоя:

- domain: самый чистый слой, содержащий модели и сервисы предметной области, иными словами, наиболее чистую бизнес-логику;
- presentation: слой, представляющий графическую составляющую приложения и логику взаимодействия с пользователем. Может содержать виджеты, страницы и сервисы, необходимые для этого слоя. Зависит от слоя domain и использует его публичные сервисы для реализации пользовательского опыта;
- infrastructure: слой, зависящий от всех остальных слоёв и имеющий наиболее полную картину всего модуля. В нём реализуются некоторые сервисы предметной области и слоя презентации, которые нельзя или не следует реализовывать там, где они объявлены. Например, в этом слое происходит всё взаимодействие с внешними источниками данных: их получение, отправка, маппинг.

Изоляция слоёв с помощью пакетов позволяет в полной мере задействовать принцип инверсии зависимостей на практике: невозможно использовать сервис или модель в том слоё, для которого она не предназначена по Dependency Rule.

Каждый слой имеет свой Pubspec файл, что позволяет использовать зависимости из pub.dev только в тех местах, где это нужно. Можно также прописывать и зависимости между слоями, но для автоматизации и предотвращении ошибок используется CLI, генерирующий pubspec_overrides.yaml на основе modulespec.yaml, который находится в корне каждого модуля.

Модули также могут зависеть друг от друга. Тогда слои зависимого модуля соответственно зависят от слоёв модуля-зависимости.

Модули app и core являются обязательными и генерируются автоматически. Модуль core является зависимостью для всех остальных слоев, а модуль app нужен для того, чтобы интегрировать другие модули, если нет возможности создать для интеграции отдельный модуль.

Помимо модулей, в проекте также есть пакет todo_app, который является точкой входа. Он импортирует все модули, задействованные в приложении (все их слои) и собирает в итоговое приложение. По сути это и есть основной пакет приложения, поэтому в Pubspec файле проекта можно указать основную информацию — описание приложения, версию.

#### Также было реализовано

- [x] Тёмная тема
- [x] Локализация
- [x] Navigator 2.0
- [x] Firebase App Distribution
- [x] Firebase Crashlytics
- [x] Remote Config: переключение цвета важности
- [x] Firebase Analytics
- [x] Анимации
- [x] Поддержка горизонтальной ориентации
- [x] Deeplink
- [x] Поддержка больших экранов
- [x] Unit-тесты
- [x] Интеграционные тесты
- [x] Flavors (Testing, Production)
